<style>
pre { border: 1px solid #aaa; background-color: #eee; padding: 10px; }
</style>
<h1>Hello</h1>

<button id="go">Activate!</button>

<pre id="log"></pre>

<script>

//// bluetooth

var powerMeasurement;

function log(str) {
  document.getElementById("log").innerText += new Date().toLocaleString() + " > " + str + "\n";
  window.scrollTo(0,document.body.scrollHeight);
}

function onDisconnected() {
  log('> Bluetooth Device disconnected');
  initBt(this);
}

async function initBt(existingDevice) {
  const serviceUuid = "cycling_power";
  const characteristicUuid = "cycling_power_measurement";

  try {
    let device = null;

    if (existingDevice) {
      log('Using existing bluetooth device...');
      device = existingDevice;
    }
    else {
      log('Requesting new Bluetooth Device...');
      device = await navigator.bluetooth.requestDevice({
        filters: [{services: [serviceUuid]}]});

      device.addEventListener('gattserverdisconnected', onDisconnected);
    }

    var server;

    while (!server) {
      log('Connecting to GATT Server...');

      try {
        server = await device.gatt.connect();
      }
      catch (e) {
        log("err while connecting, will sleep " + e);
        await new Promise(r => setTimeout(r, 2000));
      }
    }

    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    powerMeasurement = await service.getCharacteristic(characteristicUuid);

    await powerMeasurement.startNotifications();

    log('> Notifications started');
    powerMeasurement.addEventListener('characteristicvaluechanged', handleNotifications);

  } catch(error) {
    log('Argh! ' + error);
  }
}

async function onStopButtonClick() {
  if (powerMeasurement) {
    try {
      await powerMeasurement.stopNotifications();
      log('> Notifications stopped');
      powerMeasurement.removeEventListener('characteristicvaluechanged',
          handleNotifications);
    } catch(error) {
      log('Argh! ' + error);
    }
  }
}

const flags = [
  "Pedal Power Balance Present",
  "Pedal Power Balance Reference",
  "Accumulated Torque Present",
  "Accumulated Torque Source",
  "Wheel Revolution Data Present",
  "Crank Revolution Data Present",
  "Extreme Force Magnitudes Present",
  "Extreme Torque Magnitudes Present",
  "Extreme Angles Present",
  "Top Dead Spot Angle Present",
  "Bottom Dead Spot Angle Present",
  "Accumulated Energy Present",
  "Offset Compensation Indicator"
]

function handleNotifications(event) {
  let data = event.target.value; // dataview of buffer.

  var features = data.getUint8(0) + (data.getUint8(1) << 8);

  flags.forEach(function(feature, offset) {
    if ((features >> offset) & 1 == 1) {
      // console.log(feature)
    }
  })

  if (features != (16 | 32 | 2048)) {
    console.error("Exact flags are not set, this will not work.");
  }

  var values = {
    "ipower" : littleEndianInt(data,  2, 2, true),
    "wrev"   : littleEndianInt(data,  4, 4, false),
    "wtime"  : littleEndianInt(data,  8, 2, false) * (2**-11),
    "crev"   : littleEndianInt(data, 10, 2, false),
    "ctime"  : littleEndianInt(data, 12, 2, false) * (2**-10),
    "joules" : littleEndianInt(data, 14, 2, false) * (10**3)
  }

  // console.table(values);

  lastBt = values;
  lastBtTime = new Date();
  showLatest();
}

// extracts data with the correct endianness for bluetooth.
// little endian intN, where N is number of bytes (length).
function littleEndianInt(data, offset, length, signed) {
  var val = 0;

  for (var i = 0; i < length; i++) {
    val += signed ? data.getInt8(offset + i) : data.getUint8(offset + i) << (i * 8);
  }

  return val;
}




//// gps

function handlePosition(pos) {
  console.log(pos);

  lastPos = pos;
  lastPosTime = new Date();

  showLatest();
}

function initGps() {
  navigator.geolocation.watchPosition(handlePosition, function(e) { log("GPS Error: " + e) }, {
    enableHighAccuracy: true,
    maximumAge: 30 * 1000
  })
}

//// global data

let lastPos = null;
let lastBt = null;

let lastPosTime = new Date(0);
let lastBtTime = new Date(0);

function showLatest() {
  const pos = lastPos;
  const read = lastBt;
  const now = new Date();

  log((now - lastPosTime) / 1000 + "s ago " + pos.coords.latitude + "," + pos.coords.longitude + " to " + pos.coords.accuracy + " meters");
  log((now - lastBtTime) / 1000 + "s ago " + JSON.stringify(read));
}

//// wiring

document.getElementById("go").addEventListener('click', function(){
  log("Starting up by request!");
  initBt();
  initGps();
  log("Systems initialized");
});

log("Page initialized");

/*

TODO:
 add to local storage
 generate tcx or gpx (see strava docs)
 vibrate on disconnect?

 */
</script>
